<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ø¯ ÙÙˆØ§ØªÙŠØ± - Mobile Zone</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0f6cff;--accent-2:#0b4bd6;--muted:#6b7280;--bg:#f7fafc;--card:#ffffff}
    *{box-sizing:border-box}
    body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);margin:0;padding:20px;color:#0b1220}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo-wrap{display:flex;align-items:center;gap:10px}
    .logo-box{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#5b9dff);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;box-shadow:0 6px 18px rgba(15,108,255,0.18)}
    h1{margin:0;font-size:20px}
    .phone{color:var(--muted);font-size:14px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(11,18,32,0.06)}

    /* layout */
    .top-controls{display:flex;gap:8px;align-items:center}
    .lang-switch{border-radius:8px;padding:8px 10px;border:1px solid #e6e9ef;background:#fff;cursor:pointer}

    form .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=tel], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;font-size:14px}

    .items-table{width:100%;border-collapse:collapse;margin-top:8px}
    .items-table th, .items-table td{padding:10px;border-bottom:1px solid #eef2f6;text-align:center}
    .items-table th{background:#fbfdff;color:var(--muted);font-weight:600}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn-primary{background:var(--accent);color:white;box-shadow:0 8px 20px rgba(15,108,255,0.18)}
    .btn-ghost{background:transparent;border:1px solid #e6e9ef;color:var(--muted)}
    .btn-danger{background:#ff6b6b;color:white}

    .totals{display:flex;justify-content:flex-end;margin-top:14px;gap:12px;align-items:center}
    .totals .box{background:#fbfbff;padding:10px 14px;border-radius:10px;border:1px solid #eef2f6}
    .totals strong{display:block;font-size:18px}

    /* invoice preview */
    .invoice-preview{margin-top:18px}
    .invoice{background:linear-gradient(180deg,#fff,#fbfdff);padding:18px;border-radius:12px}
    .invoice header{display:flex;align-items:center;justify-content:space-between}
    .meta{display:flex;flex-direction:column;align-items:flex-end}
    .meta .muted{color:var(--muted);font-size:13px}
    .invoice-table{width:100%;margin-top:12px;border-collapse:collapse}
    .invoice-table th, .invoice-table td{padding:10px;border-bottom:1px solid #eef2f6;text-align:center}

    /* saved invoices */
    .side-panel{margin-top:14px;display:flex;gap:12px}
    .saved-list{min-width:260px;max-height:420px;overflow:auto;padding:8px;border-radius:10px;border:1px dashed #e6e9ef;background:#fff}
    .saved-item{padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}

    /* responsive */
    @media (max-width:900px){.grid{grid-template-columns:1fr}.meta{align-items:flex-start}}

    /* rtl/ltr handling */
    :root[dir='ltr']{direction:ltr}
    :root[dir='ltr'] input, :root[dir='ltr'] textarea{direction:ltr}

    /* print */
    @media print{body{background:white}.actions, .card form, .saved-list{display:none}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo-wrap">
          <div class="logo-box" id="logo-box" title="Mobile Zone">
            <!-- Inline SVG logo -->
            <svg width="38" height="38" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="3" width="20" height="18" rx="3" fill="white" opacity="0.06"/>
              <path d="M7 7h10v2H7zM7 11h6v2H7z" fill="white" opacity="0.9"/>
            </svg>
          </div>
          <div>
            <h1 id="brand-title">Mobile Zone</h1>
            <div class="phone" id="brand-phone">ğŸ“ 01061409003</div>
          </div>
        </div>
      </div>

      <div class="top-controls">
        <div class="lang-switch" id="lang-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">AR / EN</div>
        <div class="card" style="padding:8px;border-radius:10px">Ù†Ø³Ø®Ø©: Brand Edition + Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ + CSV</div>
      </div>
    </header>

    <div class="card">
      <form id="invoice-form" onsubmit="return false;">
        <div class="grid">
          <div>
            <label data-i18n="lblCustomer">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="text" id="customer-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" required />
          </div>
          <div>
            <label data-i18n="lblPhone">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="tel" id="customer-phone" placeholder="010xxxxxxxx" />
          </div>
        </div>

        <div class="grid">
          <div>
            <label data-i18n="lblInvoiceNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
            <input type="text" id="invoice-number" readonly />
          </div>
          <div>
            <label data-i18n="lblDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
            <input type="text" id="invoice-date" readonly />
          </div>
        </div>

        <div style="margin-top:6px">
          <label data-i18n="lblNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="invoice-notes" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¶Ù…Ø§Ù† Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©"></textarea>
        </div>

        <div style="margin-top:12px">
          <table class="items-table" id="items-table">
            <thead>
              <tr>
                <th data-i18n="thProduct">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th data-i18n="thQty">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th data-i18n="thPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th data-i18n="thTotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                <th data-i18n="thAction">Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="items-body"></tbody>
          </table>

          <div class="actions">
            <button class="btn-ghost" id="add-item">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            <button class="btn-ghost" id="reset-items" type="button">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-ghost" id="save-invoice" type="button">ğŸ’¾ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø©</button>
            <button class="btn-ghost" id="export-csv" type="button">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
            <div style="flex:1"></div>
            <button class="btn-primary" id="generate-pdf">Ø¥Ù†Ø´Ø§Ø¡ PDF</button>
            <button class="btn-ghost" id="preview-btn" type="button">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
          </div>

          <div class="totals">
            <div class="box">
              <div class="small" data-i18n="lblSubtotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
              <strong id="sub-total">0.00 Ø¬.Ù…</strong>
            </div>
            <div class="box" title="Ø§Ù†Ù‚Ø± Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…">
              <div class="small" data-i18n="lblDiscount">Ø§Ù„Ø®ØµÙ…</div>
              <strong><span id="discount">0</span>%</strong>
            </div>
            <div class="box">
              <div class="small" data-i18n="lblTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ</div>
              <strong id="total">0.00 Ø¬.Ù…</strong>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="side-panel">
      <div style="flex:1">
        <div class="invoice-preview">
          <div class="invoice card" id="invoice-preview">
            <header>
              <div>
                <div style="font-weight:800;font-size:18px" id="pv-brand">Mobile Zone</div>
                <div class="small" id="pv-phone">ğŸ“ 01061409003</div>
              </div>
              <div class="meta">
                <div id="preview-inv-number">ÙØ§ØªÙˆØ±Ø© #</div>
                <div class="muted" id="preview-date">ØªØ§Ø±ÙŠØ®</div>
                <div class="muted" id="preview-customer">Ø§Ù„Ø¹Ù…ÙŠÙ„: -</div>
              </div>
            </header>

            <table class="invoice-table" id="invoice-table-preview">
              <thead>
                <tr>
                  <th data-i18n="thProduct">Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th data-i18n="thQty">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th data-i18n="thPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th data-i18n="thTotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                </tr>
              </thead>
              <tbody id="invoice-items-preview"></tbody>
            </table>

            <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:18px;align-items:center">
              <div style="text-align:right">
                <div class="small" data-i18n="lblSubtotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
                <div id="preview-subtotal">0.00 Ø¬.Ù…</div>
              </div>
              <div style="text-align:right">
                <div class="small" data-i18n="lblDiscount">Ø§Ù„Ø®ØµÙ…</div>
                <div id="preview-discount">0%</div>
              </div>
              <div style="text-align:right">
                <div class="small" data-i18n="lblTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                <div id="preview-total" style="font-weight:800;font-size:18px">0.00 Ø¬.Ù…</div>
              </div>
            </div>

            <div style="margin-top:12px;color:var(--muted);font-size:13px" id="pv-notes">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙƒØ¥Ø«Ø¨Ø§Øª Ù„Ù„Ø´Ø±Ø§Ø¡. Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±: 01061409003</div>

            <hr style="margin-top:12px;border:none;border-top:1px dashed #eef2f6" />
            <div style="margin-top:10px;font-size:13px;color:#444">
              <strong data-i18n="warrantyTitle">Ø´Ø±ÙˆØ· Ø§Ù„Ø¶Ù…Ø§Ù†</strong>
              <div id="warranty-text">Ø§Ù„Ø¶Ù…Ø§Ù† ÙŠØ´Ù…Ù„ Ø¹ÙŠÙˆØ¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø© Ù„Ù…Ø¯Ø© Ø¹Ø§Ù…ØŒ ÙˆÙ„Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„ÙƒØ³Ø± Ø£Ùˆ Ø³ÙˆØ¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</div>
            </div>
          </div>
        </div>
      </div>

      <div style="width:300px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong data-i18n="savedTitle">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</strong>
            <button class="btn-ghost" id="clear-storage">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          </div>
          <input type="text" id="search-saved" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px" />
          <div class="saved-list" id="saved-list"></div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    // Ø¹Ù†Ø§ØµØ±
    const itemsBody = document.getElementById('items-body');
    const addItemBtn = document.getElementById('add-item');
    const resetBtn = document.getElementById('reset-items');
    const subTotalEl = document.getElementById('sub-total');
    const totalEl = document.getElementById('total');
    const discountEl = document.getElementById('discount');
    const generatePdfBtn = document.getElementById('generate-pdf');
    const previewBtn = document.getElementById('preview-btn');
    const saveInvoiceBtn = document.getElementById('save-invoice');
    const exportCsvBtn = document.getElementById('export-csv');

    const invNumberInput = document.getElementById('invoice-number');
    const invDateInput = document.getElementById('invoice-date');

    const previewInvNumber = document.getElementById('preview-inv-number');
    const previewDate = document.getElementById('preview-date');
    const previewCustomer = document.getElementById('preview-customer');
    const invoiceItemsPreview = document.getElementById('invoice-items-preview');
    const previewSubtotal = document.getElementById('preview-subtotal');
    const previewDiscount = document.getElementById('preview-discount');
    const previewTotal = document.getElementById('preview-total');

    const customerNameInput = document.getElementById('customer-name');
    const customerPhoneInput = document.getElementById('customer-phone');
    const notesInput = document.getElementById('invoice-notes');
    const pvBrand = document.getElementById('pv-brand');
    const pvPhone = document.getElementById('pv-phone');
    
    const savedListEl = document.getElementById('saved-list');
    const searchSaved = document.getElementById('search-saved');
    const clearStorageBtn = document.getElementById('clear-storage');

    const langToggle = document.getElementById('lang-toggle');
    let lang = localStorage.getItem('mz_lang') || 'ar';

    // i18n simple map
    const i18n = {
      ar: {
        lblCustomer:'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', lblPhone:'Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„', lblInvoiceNo:'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', lblDate:'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©', lblNotes:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
        thProduct:'Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©', thQty:'Ø§Ù„ÙƒÙ…ÙŠØ©', thPrice:'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', thTotal:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', thAction:'Ø¥Ø¬Ø±Ø§Ø¡',
        lblSubtotal:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', lblDiscount:'Ø§Ù„Ø®ØµÙ…', lblTotal:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ',
        savedTitle:'Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', warrantyTitle:'Ø´Ø±ÙˆØ· Ø§Ù„Ø¶Ù…Ø§Ù†'
      },
      en: {
        lblCustomer:'Customer Name', lblPhone:'Phone', lblInvoiceNo:'Invoice #', lblDate:'Date', lblNotes:'Notes (optional)',
        thProduct:'Product / Service', thQty:'Qty', thPrice:'Unit Price', thTotal:'Total', thAction:'Action',
        lblSubtotal:'Subtotal', lblDiscount:'Discount', lblTotal:'Net Total',
        savedTitle:'Saved Invoices', warrantyTitle:'Warranty Terms'
      }
    };

    // init
    function pad(n){return n.toString().padStart(2,'0')}
    function initInvoiceMeta(){
      const d = new Date();
      const num = 'MZ'+d.getFullYear().toString().slice(-2)+pad(d.getMonth()+1)+pad(d.getDate())+Math.floor(Math.random()*900+100);
      invNumberInput.value = num;
      invDateInput.value = d.toLocaleDateString(lang==='ar'?'ar-EG':'en-GB');
      previewInvNumber.textContent = (lang==='ar'? 'ÙØ§ØªÙˆØ±Ø© #':'Invoice #') + ' ' + num;
      previewDate.textContent = d.toLocaleDateString(lang==='ar'?'ar-EG':'en-GB');
    }
    initInvoiceMeta();

    function setLang(l){
      lang = l;
      localStorage.setItem('mz_lang',l);
      document.documentElement.lang = (l==='ar'?'ar':'en');
      document.documentElement.dir = (l==='ar'?'rtl':'ltr');
      // update texts
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(i18n[l] && i18n[l][key]) el.textContent = i18n[l][key];
      });
      document.getElementById('pv-notes').textContent = (l==='ar' ? 'Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙƒØ¥Ø«Ø¨Ø§Øª Ù„Ù„Ø´Ø±Ø§Ø¡. Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±: 01061409003' : 'Note: Keep this invoice as proof of purchase. For inquiries: 01061409003');
      document.getElementById('warranty-text').textContent = (l==='ar' ? 'Ø§Ù„Ø¶Ù…Ø§Ù† ÙŠØ´Ù…Ù„ Ø¹ÙŠÙˆØ¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø© Ù„Ù…Ø¯Ø© Ø¹Ø§Ù…ØŒ ÙˆÙ„Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„ÙƒØ³Ø± Ø£Ùˆ Ø³ÙˆØ¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….' : 'Warranty covers manufacturing defects for one year; does not cover physical damage or misuse.');
      initInvoiceMeta();
    }
    setLang(lang);
    langToggle.addEventListener('click', ()=>{ setLang(lang==='ar'?'en':'ar'); });

    // items
    function addItem(name='',qty=1,price=0){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="item-name" value="${name}" placeholder="Ù…Ø«Ø§Ù„: Ø³Ù„Ùƒ Ø´Ø§Ø­Ù†" /></td>
        <td><input type="number" class="item-qty" min="1" value="${qty}" style="width:80px" /></td>
        <td><input type="number" class="item-price" min="0" value="${price}" style="width:120px" /></td>
        <td class="item-total">0.00</td>
        <td><button class="btn-ghost btn-remove" type="button">Ø­Ø°Ù</button></td>
      `;
      itemsBody.appendChild(tr);
      bindRowEvents(tr);
      recalcTotals();
    }
    function bindRowEvents(row){
      const qty = row.querySelector('.item-qty');
      const price = row.querySelector('.item-price');
      const remove = row.querySelector('.btn-remove');
      function change(){
        const q = Number(qty.value||0);
        const p = Number(price.value||0);
        const tot = (q*p);
        row.querySelector('.item-total').textContent = tot.toFixed(2);
        recalcTotals();
      }
      qty.addEventListener('input', change);
      price.addEventListener('input', change);
      row.querySelector('.item-name').addEventListener('input', recalcTotals);
      remove.addEventListener('click', ()=>{ row.remove(); recalcTotals(); });
      change();
    }

    function recalcTotals(){
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      let subtotal = 0;
      rows.forEach(r=>{
        const q = Number(r.querySelector('.item-qty').value||0);
        const p = Number(r.querySelector('.item-price').value||0);
        subtotal += q*p;
      });
      const discountPct = Number(discountEl.textContent||0);
      const discounted = subtotal * (1 - discountPct/100);

      subTotalEl.textContent = subtotal.toFixed(2) + (lang==='ar'?' Ø¬.Ù…':' EGP');
      totalEl.textContent = discounted.toFixed(2) + (lang==='ar'?' Ø¬.Ù…':' EGP');

      previewSubtotal.textContent = subtotal.toFixed(2) + (lang==='ar'?' Ø¬.Ù…':' EGP');
      previewDiscount.textContent = discountPct + '%';
      previewTotal.textContent = discounted.toFixed(2) + (lang==='ar'?' Ø¬.Ù…':' EGP');

      invoiceItemsPreview.innerHTML = '';
      rows.forEach(r=>{
        const nm = r.querySelector('.item-name').value || '-';
        const q = Number(r.querySelector('.item-qty').value||0);
        const p = Number(r.querySelector('.item-price').value||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(nm)}</td><td>${q}</td><td>${p.toFixed(2)}</td><td>${(q*p).toFixed(2)}</td>`;
        invoiceItemsPreview.appendChild(tr);
      });

      previewCustomer.textContent = (lang==='ar'?'Ø§Ù„Ø¹Ù…ÙŠÙ„: ':'Customer: ') + (customerNameInput.value || '-');
    }

    function escapeHtml(text){
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":"&#039;" };
      return String(text).replace(/[&<>"']/g, (m)=> map[m]);
    }

    addItemBtn.addEventListener('click', (e)=>{ e.preventDefault(); addItem(); });
    resetBtn.addEventListener('click', (e)=>{ e.preventDefault(); itemsBody.innerHTML = ''; addItem('Ø´Ø§Ø­Ù† Ø³Ø±ÙŠØ¹',1,250); addItem('ÙˆØ§Ù‚ÙŠ Ø´Ø§Ø´Ø©',2,80); recalcTotals(); });

    discountEl.parentElement.addEventListener('dblclick', ()=>{
      const val = prompt(lang==='ar'?'Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)':'Enter discount (%)', discountEl.textContent||0);
      const n = Number(val);
      if(!isNaN(n) && n>=0){ discountEl.textContent = n; recalcTotals(); }
    });
    previewBtn.addEventListener('click', ()=>{ recalcTotals(); document.getElementById('invoice-preview').scrollIntoView({behavior:'smooth'}); });

    generatePdfBtn.addEventListener('click', async ()=>{
      recalcTotals();
      if(itemsBody.querySelectorAll('tr').length === 0){ alert(lang==='ar'?'Ø£Ø¶Ù Ø¹Ù†ØµØ±Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„':'Add at least one item'); return; }
      const customer = customerNameInput.value.trim();
      if(!customer){ alert(lang==='ar'?'Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„':'Enter customer name'); customerNameInput.focus(); return; }

      const preview = document.getElementById('invoice-preview');
      const opt = { margin:[0.4,0.4,0.4,0.4], filename: invNumberInput.value + '.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };

      generatePdfBtn.disabled = true;
      const prevText = generatePdfBtn.textContent;
      generatePdfBtn.textContent = (lang==='ar'?'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...':'Generating...');
      try{
        await html2pdf().set(opt).from(preview).save();
      }catch(err){
        console.error(err);
        alert(lang==='ar'?'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„PDF':'Error generating PDF');
      }finally{
        generatePdfBtn.disabled = false;
        generatePdfBtn.textContent = prevText || (lang==='ar'?'Ø¥Ù†Ø´Ø§Ø¡ PDF':'Generate PDF');
      }
    });

    // LocalStorage: save/load list of invoices
    function getSaved(){ try{ return JSON.parse(localStorage.getItem('mz_invoices') || '[]'); }catch(e){ return []; } }
    function saveAll(list){ localStorage.setItem('mz_invoices', JSON.stringify(list)); }

    saveInvoiceBtn.addEventListener('click', ()=>{
      recalcTotals();
      if(itemsBody.querySelectorAll('tr').length === 0){ alert(lang==='ar'?'Ø£Ø¶Ù Ø¹Ù†ØµØ±Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„':'Add at least one item'); return; }
      const invoice = collectInvoice();
      const all = getSaved();
      all.unshift(invoice);
      saveAll(all);
      renderSavedList();
      alert(lang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§':'Invoice saved locally');
    });

    function collectInvoice(){
      const items = Array.from(itemsBody.querySelectorAll('tr')).map(r => ({ name: r.querySelector('.item-name').value, qty: Number(r.querySelector('.item-qty').value), price: Number(r.querySelector('.item-price').value) }));
      return {
        id: invNumberInput.value,
        date: invDateInput.value,
        customer: customerNameInput.value,
        phone: customerPhoneInput.value,
        notes: notesInput.value,
        items: items,
        subtotal: subTotalEl.textContent,
        total: totalEl.textContent,
        discount: discountEl.textContent
      };
    }

    function renderSavedList(filter=''){
      const list = getSaved();
      savedListEl.innerHTML = '';
      list.filter(inv => ( (inv.customer || '') + ' ' + (inv.id || '') ).toLowerCase().includes((filter||'').toLowerCase())).forEach(inv => {
        const div = document.createElement('div');
        div.className = 'saved-item';
        div.innerHTML = `
          <div style="flex:1">
            <strong>${escapeHtml(inv.customer || '-')}</strong>
            <div class="small">${escapeHtml(inv.id || '')} â€¢ ${escapeHtml(inv.date || '')}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn-ghost btn-load" type="button">${lang==='ar'?'Ø¹Ø±Ø¶':'View'}</button>
            <button class="btn-danger btn-delete" type="button">${lang==='ar'?'Ø­Ø°Ù':'Delete'}</button>
          </div>
        `;
        div.querySelector('.btn-load').addEventListener('click', ()=>{ loadInvoice(inv.id); });
        div.querySelector('.btn-delete').addEventListener('click', ()=>{ if(confirm(lang==='ar'?'Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ':'Delete invoice?')){ deleteInvoice(inv.id); } });
        savedListEl.appendChild(div);
      });
    }

    function loadInvoice(id){
      const list = getSaved();
      const inv = list.find(x => x.id === id);
      if(!inv) return;
      itemsBody.innerHTML = '';
      (inv.items || []).forEach(it => addItem(it.name, it.qty, it.price));
      customerNameInput.value = inv.customer || '';
      customerPhoneInput.value = inv.phone || '';
      notesInput.value = inv.notes || '';
      discountEl.textContent = inv.discount || 0;
      invNumberInput.value = inv.id;
      invDateInput.value = inv.date;
      recalcTotals();
    }

    function deleteInvoice(id){
      let list = getSaved();
      list = list.filter(x => x.id !== id);
      saveAll(list);
      renderSavedList();
    }

    clearStorageBtn.addEventListener('click', ()=>{
      if(confirm(lang==='ar'?'Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ':'Clear all saved invoices?')){
        localStorage.removeItem('mz_invoices');
        renderSavedList();
      }
    });

    searchSaved.addEventListener('input', ()=>{ renderSavedList(searchSaved.value); });

    // CSV export
    exportCsvBtn.addEventListener('click', ()=>{
      const list = getSaved();
      if(!list || list.length === 0){ alert(lang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ØªØµØ¯ÙŠØ±':'No saved invoices to export'); return; }
      // flatten to rows
      const rows = [];
      list.forEach(inv => {
        (inv.items || []).forEach(it => {
          rows.push({ id: inv.id, date: inv.date, customer: inv.customer, phone: inv.phone, product: it.name, qty: it.qty, price: it.price, subtotal: (inv.subtotal || '').replace(/[^0-9.]/g, ''), total: (inv.total || '').replace(/[^0-9.]/g, '') });
        });
      });
      const headers = ['Invoice ID','Date','Customer','Phone','Product','Qty','Unit Price','Subtotal','Total'];
      const csv = [headers.join(',')].concat(rows.map(r => [r.id, r.date, `"${(r.customer||'').replace(/"/g,'""')}"`, r.phone, `"${(r.product||'').replace(/"/g,'""')}"`, r.qty, r.price, r.subtotal, r.total].join(','))).join('
');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mobilezone_invoices.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // initial content
    addItem('Ø´Ø§Ø­Ù† Ø³Ø±ÙŠØ¹',1,250);
    addItem('ÙˆØ§Ù‚ÙŠ Ø´Ø§Ø´Ø©',2,80);
    recalcTotals();
    renderSavedList();

    // ensure saved list renders on load
    document.addEventListener('DOMContentLoaded', ()=>{ renderSavedList(); });

  </script>
</body>
</html>
